import requests
import pyodbc

# replace YOUR_API_KEY with your actual API key
api_key = "6d0c7ec3fb617dc3d67c92f6d4f938ee"

# connect to the SQL database
conn = pyodbc.connect('DRIVER={SQL Server};'
                      'SERVER=server_name;'
                      'DATABASE=database_name;'
                      'Trusted_Connection=yes;')

# create a new table to store the weather data
cursor = conn.cursor()
cursor.execute('CREATE TABLE WeatherData ('
               'City VARCHAR(50),'
               'Temperature FLOAT,'
               'Humidity INT,'
               'WindSpeed FLOAT'
               ')')
conn.commit()

# retrieve a list of cities from the database
cursor.execute('SELECT City FROM Cities')
cities = [row[0] for row in cursor.fetchall()]

# insert the weather data for each city into the new table
for city in cities:
    # construct the API URL
    url = f"http://api.openweathermap.org/data/2.5/weather?q={city}&appid={api_key}"

    # make the API request
    response = requests.get(url)

    # check if the request was successful
    if response.status_code == 200:
        # extract the weather data from the response
        data = response.json()
        temperature = data["main"]["temp"]
        humidity = data["main"]["humidity"]
        wind_speed = data["wind"]["speed"]

        # insert the weather data into the new table
        cursor.execute('INSERT INTO WeatherData (City, Temperature, Humidity, WindSpeed) '
                       'VALUES (?, ?, ?, ?)', city, temperature, humidity, wind_speed)
        conn.commit()
    else:
        print(f"Failed to retrieve weather data for {city}.")

# close the database connection
conn.close()

